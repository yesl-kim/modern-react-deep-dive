# 가상 DOM과 리액트 파이버

## 리액트가 해결하고자 한 문제

### 문제

- 브라우저 렌더링 측면: SPA에서는 초기 렌더링 이후에도 화면에 변경되는 일이 잦다 (리렌더링이 잦다) -> 이는 **많은 렌더링 비용과 성능 문제**로 이어진다
- DX 측면: 앱이 복잡해질수록 **반응성 관리**가 어렵다. 상태과 ui 간의 상호작용과 이를 통한 dom 조작이 얼마나 복잡해질지 상상해보자

### 해결

- 그래서 등장한 것이 가상 DOM, 이를 이루고 있는 아키텍처가 파이버
- **화면에 표시할 UI를 자바스크립트 객체 형태의 "값"으로 메모리에 저장해둠으로서 자바스크립트로 렌더링을 제어할 수 있게 되었다는 것이 가상 dom의 핵심 이점이다.**
- ui를 값으로 저장하여 업데이트 주기에 맞춰 여러 변경사항을 한 번에 적용하여 렌더링 성능을 꽤 괜찮은 정도로 개선시킬 수 있고 (업데이트가 잦은 대부분의 경우 한 번에 업데이트하는게 좋겠지? 업데이트가 아주 단순한 경우보단)
- 가상 돔을 이루는 fiber는 자신이 참조하는 상태값(props, state)를 모두 저장, 내부적으로 이런 반응성 관리를 추상화해놓고 있다.
- 추가로 가상 돔을 생성하는 작업은 fiber 단위의 작은 작업으로 나누어 중간에 멈추고 나중에 다시 재개할 수도, 우선순위에 다라 작업 순서를 정할 수도 있다.

### 디테일: 리액트 렌더링과 파이버

- 리액트 렌더링 과정은 크게 렌더와 커밋 단계로 나뉜다.
- 렌더 단계는 가상 돔을 생성하는 과정으로 각 리액트 엘리먼트가 파이버로 생성되어 이를 트리 구조로 연결한다. (파이버 트리~~)
- 파이버 트리는 이미 커밋된, 현재 상태의 트리와 커밋되어야할 트리. 두 가지 버전으로 저장되고, 각 파이버는 이전 상태 (이미 커밋된 파이버)를 참조하고 있다.
- 상태가 변경되거나 돔이 변경되어야 할 때, 파이버 트리를 순회하며 변경사항을 확인한다 (재조정)
- 변경된 새로운 파이버 트리를 생성하는 것까지가 렌더 단계이다.
- 렌더 단계는 작은 단위로 나누어 진행되며 스케줄링되어있다. 그 사이 더 중요한 작업을 우선 수행할 수 있다. (= 렌더단계는 비동기적으로 진행)
- 커밋 단계는 파이버 트리를 실제 dom에 적용하는 단계이다.
- 커밋 단계는 재귀적으로 실행 -> 실제 ui가 사용자에게 보이는 단계이기 때문에 멈출 수 없다. (= 동기적으로 진행)

## 더 알아보기

- 부모 컴포넌트가 리렌더링되면 하위 컴포넌트는 변경여부 상관없이 모두 리렌더링된다.
